---
# Role: security
# SSH hardening, firewalld, fail2ban, SELinux enforcing, automatic updates.

# ── SSH Hardening ──
- name: Deploy hardened sshd_config.
  become: true
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0600"
    validate: 'sshd -t -f %s'
  notify: restart sshd

# ── Firewalld ──
- name: Ensure firewalld is installed.
  become: true
  ansible.builtin.dnf:
    name: firewalld
    state: present

- name: Ensure firewalld is running and enabled.
  become: true
  ansible.builtin.systemd:
    name: firewalld
    state: started
    enabled: true

- name: Configure firewalld - allow required services.
  become: true
  ansible.posix.firewalld:
    service: "{{ item }}"
    zone: public
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ firewall_allowed_services }}"

# ── fail2ban ──
- name: Install fail2ban.
  become: true
  ansible.builtin.dnf:
    name: fail2ban
    state: present

- name: Deploy fail2ban jail.local.
  become: true
  ansible.builtin.copy:
    content: |
      # Managed by Ansible
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 3
      backend = systemd

      [sshd]
      enabled = true
      port = {{ security_ssh_port }}
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: "0644"
  notify: restart fail2ban

- name: Ensure fail2ban is running and enabled.
  become: true
  ansible.builtin.systemd:
    name: fail2ban
    state: started
    enabled: true

# ── SELinux ──
- name: Ensure python3-libselinux is installed.
  become: true
  ansible.builtin.dnf:
    name: python3-libselinux
    state: present

- name: Ensure SELinux is enforcing.
  become: true
  ansible.posix.selinux:
    policy: targeted
    state: enforcing

# ── Automatic security updates ──
- name: Install dnf-automatic.
  become: true
  ansible.builtin.dnf:
    name: dnf-automatic
    state: present

- name: Enable dnf-automatic timer for security updates.
  become: true
  ansible.builtin.systemd:
    name: dnf-automatic.timer
    state: started
    enabled: true
