#!/usr/bin/env bash
# {{ ansible_managed }}
# Decrypts SOPS-encrypted secrets to a tmpfs directory.
# Called by the decrypt-secrets.service systemd user unit.
set -euo pipefail

SOPS={{ user_home }}/.local/bin/sops
SECRETS={{ sops_secrets_file }}
OUTDIR={{ secrets_dir }}
export SOPS_AGE_KEY_FILE={{ age_key_file }}

/usr/bin/mkdir -p "$OUTDIR"
/usr/bin/chmod 700 "$OUTDIR"

# ── Immich .env ──
IMMICH_DB_PASSWORD=$($SOPS --extract '["immich"]["db_password"]' -d "$SECRETS")

/usr/bin/cat > "$OUTDIR/immich.env" <<ENVEOF
DB_PASSWORD=$IMMICH_DB_PASSWORD
DB_USERNAME=postgres
DB_DATABASE_NAME=immich
POSTGRES_PASSWORD=$IMMICH_DB_PASSWORD
POSTGRES_USER=postgres
POSTGRES_DB=immich
REDIS_HOSTNAME=redis
UPLOAD_LOCATION={{ services_data_dir }}/immich/library
IMMICH_MACHINE_LEARNING_URL=http://immich-machine-learning:3003
TZ={{ timezone }}
ENVEOF

# ── NextCloud .env ──
NC_DB_PASSWORD=$($SOPS --extract '["nextcloud"]["db_password"]' -d "$SECRETS")
NC_ADMIN_USER=$($SOPS --extract '["nextcloud"]["admin_user"]' -d "$SECRETS")
NC_ADMIN_PASSWORD=$($SOPS --extract '["nextcloud"]["admin_password"]' -d "$SECRETS")

/usr/bin/cat > "$OUTDIR/nextcloud.env" <<ENVEOF
POSTGRES_PASSWORD=$NC_DB_PASSWORD
NEXTCLOUD_ADMIN_USER=$NC_ADMIN_USER
NEXTCLOUD_ADMIN_PASSWORD=$NC_ADMIN_PASSWORD
REDIS_HOST=redis
TZ={{ timezone }}
ENVEOF

/usr/bin/chmod 600 "$OUTDIR/immich.env" "$OUTDIR/nextcloud.env"

echo "Secrets decrypted to $OUTDIR"
