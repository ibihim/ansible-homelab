---
# Role: secrets
# Manages SOPS + age based secret decryption.
# Deploys the decrypt-secrets script and systemd user service.
# sops is installed by dev-tools role, age by base role.

- name: Ensure sops secrets source directory exists.
  ansible.builtin.file:
    path: "{{ sops_secrets_file | dirname }}"
    state: directory
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: "0700"

- name: Ensure age key directory exists.
  ansible.builtin.file:
    path: "{{ age_key_file | dirname }}"
    state: directory
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: "0700"

- name: Check if sops secrets.yaml exists.
  ansible.builtin.stat:
    path: "{{ sops_secrets_file }}"
  register: sops_secrets_stat

- name: Warn if sops secrets.yaml is missing.
  ansible.builtin.debug:
    msg: >
      WARNING: {{ sops_secrets_file }} does not exist.
      You need to create it with 'sops --age <public-key> {{ sops_secrets_file }}'.
      The decrypt-secrets service will fail until this file exists.
  when: not sops_secrets_stat.stat.exists

- name: Check if age key exists.
  ansible.builtin.stat:
    path: "{{ age_key_file }}"
  register: age_key_stat

- name: Warn if age key is missing.
  ansible.builtin.debug:
    msg: >
      WARNING: {{ age_key_file }} does not exist.
      You need to create it with 'age-keygen -o {{ age_key_file }}'.
      The decrypt-secrets service will fail until this file exists.
  when: not age_key_stat.stat.exists

- name: Deploy decrypt-secrets script.
  ansible.builtin.template:
    src: decrypt-secrets.sh.j2
    dest: "{{ user_home }}/.local/bin/decrypt-secrets"
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: "0755"

- name: Deploy decrypt-secrets systemd user service.
  ansible.builtin.template:
    src: decrypt-secrets.service.j2
    dest: "{{ user_home }}/.config/systemd/user/decrypt-secrets.service"
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: "0644"
  notify: restart decrypt-secrets

- name: Reload systemd user daemon.
  ansible.builtin.systemd:
    daemon_reload: true
    scope: user

- name: Enable decrypt-secrets user service.
  ansible.builtin.systemd:
    name: decrypt-secrets
    enabled: true
    scope: user
